<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 16. Sending Email and Text Messages</title><link rel="stylesheet" href="core.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.74.0"/></head><body><div class="chapter" title="Chapter 16. Sending Email and Text Messages"><div class="titlepage"><div><div><h1 class="title"><a id="sending_email_and_text_messages"/>Chapter 16. Sending Email and Text Messages</h1></div></div></div><p>Checking and replying to email is a huge time sink. Of course, you can’t just write a program to handle all your email for you, since each message requires its own response. But you can still automate plenty of email-related tasks once you know how to write programs that can send and receive email.</p><p>For example, maybe you have a spreadsheet full of customer records and want to send each customer a different form letter depending on their age and location details. Commercial software might not be able to do this for you; fortunately, you can write your own program to send these emails, saving yourself a lot of time copying and pasting form emails.</p><p>You can also write programs to send emails and SMS texts to notify you of things even while you’re away from your computer. If you’re automating a task that takes a couple of hours to do, you don’t want to go back to your computer every few minutes to check on the program’s status. Instead, the program can just text your phone when it’s done—freeing you to focus on more important things while you’re away from your computer.</p><div class="sect1" title="SMTP"><div class="titlepage"><div><div><h1 class="title"><a id="smtp"/>SMTP</h1></div></div></div><p><a id="iddle1399" class="indexterm"/><a id="iddle1404" class="indexterm"/><a id="iddle2446" class="indexterm"/>Much like HTTP is the protocol used by computers to send web pages across the Internet, <span class="emphasis"><em>Simple Mail Transfer Protocol (SMTP)</em></span> is the protocol used for sending email. SMTP dictates how email messages should be formatted, encrypted, and relayed between mail servers, and all the other details that your computer handles after you click Send. You don’t need to know these technical details, though, because Python’s <code class="literal">smtplib</code> module simplifies them into a few functions.</p><p>SMTP just deals with sending emails to others. A different protocol, called IMAP, deals with retrieving emails sent to you and is described in <a class="xref" href="ch16.html#imap" title="IMAP">IMAP</a>.</p></div><div class="sect1" title="Sending Email"><div class="titlepage"><div><div><h1 class="title"><a id="sending_email"/>Sending Email</h1></div></div></div><p>You may be familiar with sending emails from Outlook or Thunderbird or through a website such as Gmail or Yahoo! Mail. Unfortunately, Python doesn’t offer you a nice graphical user interface like those services. Instead, you call functions to perform each major step of SMTP, as shown in the following interactive shell example.</p><div class="note" title="Note"><h3 class="title"><a id="ch16note01"/>Note</h3><p><span class="emphasis"><em>Don’t enter this example in IDLE; it won’t work because</em></span> <a class="ulink" href="http://smtp.example.com">smtp.example.com</a>, <span class="email"><a class="email" href="mailto:bob@example.com">bob@example.com</a></span>, MY_SECRET_PASSWORD, <span class="emphasis"><em>and</em></span> <span class="email"><a class="email" href="mailto:alice@example.com">alice@example.com</a></span> <span class="emphasis"><em>are just placeholders. This code is just an overview of the process of sending email with Python.</em></span></p></div><a id="pro_id00564"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>import smtplib</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>smtpObj = smtplib.SMTP('smtp.example.com', 587)</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>smtpObj.ehlo()</strong></span>
(250, b'mx.example.com at your service, [216.172.148.131]\nSIZE 35882577\
n8BITMIME\nSTARTTLS\nENHANCEDSTATUSCODES\nCHUNKING')
&gt;&gt;&gt; <span class="strong"><strong>smtpObj.starttls()</strong></span>
(220, b'2.0.0 Ready to start TLS')
&gt;&gt;&gt; <span class="strong"><strong>smtpObj.login('bob@example.com', '</strong></span> <span class="emphasis"><em><span class="strong"><strong>MY_SECRET_PASSWORD</strong></span></em></span><span class="strong"><strong>')</strong></span>
(235, b'2.7.0 Accepted')
&gt;&gt;&gt; <span class="strong"><strong>smtpObj.sendmail('bob@example.com', 'alice@example.com', 'Subject: So</strong></span>
<span class="strong"><strong>long.\nDear Alice, so long and thanks for all the fish. Sincerely, Bob')</strong></span>
{}
&gt;&gt;&gt; <span class="strong"><strong>smtpObj.quit()</strong></span>
(221, b'2.0.0 closing connection ko10sm23097611pbd.52 - gsmtp')</pre><p>In the following sections, we’ll go through each step, replacing the placeholders with your information to connect and log in to an SMTP server, send an email, and disconnect from the server.</p><div class="sect2" title="Connecting to an SMTP Server"><div class="titlepage"><div><div><h2 class="title"><a id="connecting_to_an_smtp_server"/>Connecting to an SMTP Server</h2></div></div></div><p><a id="iddle1099" class="indexterm"/><a id="iddle1191" class="indexterm"/><a id="iddle1396" class="indexterm"/><a id="iddle1606" class="indexterm"/><a id="iddle1653" class="indexterm"/><a id="iddle2049" class="indexterm"/><a id="iddle2430" class="indexterm"/><a id="iddle2445" class="indexterm"/><a id="iddle2452" class="indexterm"/><a id="iddle2644" class="indexterm"/><a id="iddle2734" class="indexterm"/>If you’ve ever set up Thunderbird, Outlook, or another program to connect to your email account, you may be familiar with configuring the SMTP server and port. These settings will be different for each email provider, but a web search for <span class="emphasis"><em>&lt;your provider&gt; smtp settings</em></span> should turn up the server and port to use.</p><p>The domain name for the SMTP server will usually be the name of your email provider’s domain name, with <span class="emphasis"><em>smtp.</em></span> in front of it. For example, Gmail’s SMTP server is at <span class="emphasis"><em>smtp.gmail.com</em></span>. <a class="xref" href="ch16.html#email_providers_and_their_smtp_servers" title="Table 16-1. Email Providers and Their SMTP Servers">Table 16-1</a> lists some common email providers and their SMTP servers. (The port is an integer value and will almost always be 587, which is used by the command encryption standard, TLS.)</p><div class="table"><a id="email_providers_and_their_smtp_servers"/><p class="title">Table 16-1. Email Providers and Their SMTP Servers</p><div class="table-contents"><table summary="Email Providers and Their SMTP Servers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Provider</p></th><th style="border-bottom: 0.5pt solid ; " valign="top"><p>SMTP server domain name</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Gmail</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>smtp.gmail.com</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Outlook.com/Hotmail.com</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>smtp-mail.outlook.com</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Yahoo Mail</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>smtp.mail.yahoo.com</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>AT&amp;T</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>smpt.mail.att.net</em></span> (port 465)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Comcast</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>smtp.comcast.net</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; " valign="top"><p>Verizon</p></td><td style="" valign="top"><p><span class="emphasis"><em>smtp.verizon.net</em></span> (port 465)</p></td></tr></tbody></table></div></div><p>Once you have the domain name and port information for your email provider, create an <code class="literal">SMTP</code> object by calling <code class="literal">smptlib.SMTP()</code>, passing the domain name as a string argument, and passing the port as an integer argument. The <code class="literal">SMTP</code> object represents a connection to an SMTP mail server and has methods for sending emails. For example, the following call creates an <code class="literal">SMTP</code> object for connecting to Gmail:</p><a id="pro_id00565"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>smtpObj = smtplib.SMTP('smtp.gmail.com', 587)</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>type(smtpObj)</strong></span>
&lt;class 'smtplib.SMTP'&gt;</pre><p>Entering <code class="literal">type(smtpObj)</code> shows you that there’s an <code class="literal">SMTP</code> object stored in <code class="literal">smtpObj</code>. You’ll need this <code class="literal">SMTP</code> object in order to call the methods that log you in and send emails. If the <code class="literal">smptlib.SMTP()</code> call is not successful, your SMTP server might not support TLS on port 587. In this case, you will need to create an <code class="literal">SMTP</code> object using <code class="literal">smtplib.SMTP_SSL()</code> and port 465 instead.</p><a id="pro_id00566"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>smtpObj = smtplib.SMTP_SSL('smtp.gmail.com', 465)</strong></span></pre><div class="note" title="Note"><h3 class="title"><a id="ch16note02"/>Note</h3><p><span class="emphasis"><em>If you are not connected to the Internet, Python will raise a <code class="literal">socket.gaierror: [Errno 11004] getaddrinfo failed</code> or similar exception.</em></span></p></div><p><a id="iddle1374" class="indexterm"/><a id="iddle1398" class="indexterm"/><a id="iddle1401" class="indexterm"/><a id="iddle1403" class="indexterm"/><a id="iddle1873" class="indexterm"/><a id="iddle2448" class="indexterm"/><a id="iddle2449" class="indexterm"/><a id="iddle2451" class="indexterm"/><a id="iddle2472" class="indexterm"/><a id="iddle2578" class="indexterm"/>For your programs, the differences between TLS and SSL aren’t important. You only need to know which encryption standard your SMTP server uses so you know how to connect to it. In all of the interactive shell examples that follow, the <code class="literal">smtpObj</code> variable will contain an <code class="literal">SMTP</code> object returned by the <code class="literal">smtplib.SMTP()</code> or <code class="literal">smtplib.SMTP_SSL()</code> function.</p></div><div class="sect2" title="Sending the SMTP “Hello” Message"><div class="titlepage"><div><div><h2 class="title"><a id="sending_the_smtp_quotation_markhelloquot"/>Sending the SMTP “Hello” Message</h2></div></div></div><p>Once you have the <code class="literal">SMTP</code> object, call its oddly named <code class="literal">ehlo()</code> method to “say hello” to the SMTP email server. This greeting is the first step in SMTP and is important for establishing a connection to the server. You don’t need to know the specifics of these protocols. Just be sure to call the <code class="literal">ehlo()</code> method first thing after getting the <code class="literal">SMTP</code> object or else the later method calls will result in errors. The following is an example of an <code class="literal">ehlo()</code> call and its return value:</p><a id="pro_id00567"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>smtpObj.ehlo()</strong></span>
(250, b'mx.google.com at your service, [216.172.148.131]\nSIZE 35882577\
n8BITMIME\nSTARTTLS\nENHANCEDSTATUSCODES\nCHUNKING')</pre><p>If the first item in the returned tuple is the integer <code class="literal">250</code> (the code for “success” in SMTP), then the greeting succeeded.</p></div><div class="sect2" title="Starting TLS Encryption"><div class="titlepage"><div><div><h2 class="title"><a id="starting_tls_encryption"/>Starting TLS Encryption</h2></div></div></div><p>If you are connecting to port 587 on the SMTP server (that is, you’re using TLS encryption), you’ll need to call the <code class="literal">starttls()</code> method next. This required step enables encryption for your connection. If you are connecting to port 465 (using SSL), then encryption is already set up, and you should skip this step.</p><p>Here’s an example of the <code class="literal">starttls()</code> method call:</p><a id="pro_id00568"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>smtpObj.starttls()</strong></span>
(220, b'2.0.0 Ready to start TLS')</pre><p><code class="literal">starttls()</code> puts your SMTP connection in TLS mode. The <code class="literal">220</code> in the return value tells you that the server is ready.</p></div><div class="sect2" title="Logging in to the SMTP Server"><div class="titlepage"><div><div><h2 class="title"><a id="logging_in_to_the_smtp_server"/>Logging in to the SMTP Server</h2></div></div></div><p>Once your encrypted connection to the SMTP server is set up, you can log in with your username (usually your email address) and email password by calling the <code class="literal">login()</code> method.</p><a id="pro_id00569"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>smtpObj.login('</strong></span> <span class="emphasis"><em><span class="strong"><strong>my_email_address@gmail.com</strong></span></em></span> <span class="strong"><strong>', '</strong></span> <span class="emphasis"><em><span class="strong"><strong>MY_SECRET_PASSWORD</strong></span></em></span> <span class="strong"><strong>')</strong></span>
(235, b'2.7.0 Accepted')</pre><div class="sidebar"><a id="gmailapostrophes_application-specific_pa"/><p class="title">Gmail’s Application-Specific Passwords</p><p><a id="iddle1089" class="indexterm"/><a id="iddle1402" class="indexterm"/><a id="iddle1607" class="indexterm"/><a id="iddle1731" class="indexterm"/><a id="iddle2062" class="indexterm"/><a id="iddle2416" class="indexterm"/><a id="iddle2450" class="indexterm"/>Gmail has an additional security feature for Google accounts called <span class="emphasis"><em>application-specific passwords</em></span>. If you receive an <code class="literal">Application-specific password required</code> error message when your program tries to log in, you will have to set up one of these passwords for your Python script. Check out the resources at <span class="emphasis"><em><a class="ulink" href="http://nostarch.com/automatestuff/">http://nostarch.com/automatestuff/</a></em></span> for detailed directions on how to set up an application-specific password for your Google account.</p></div><p>Pass a string of your email address as the first argument and a string of your password as the second argument. The <code class="literal">235</code> in the return value means authentication was successful. Python will raise an <code class="literal">smtplib.SMTPAuthenticationError</code> exception for incorrect passwords.</p><div class="warning" title="Warning"><h3 class="title"><a id="ch16note03"/>Warning</h3><p><span class="emphasis"><em>Be careful about putting passwords in your source code. If anyone ever copies your program, they’ll have access to your email account! It’s a good idea to call <code class="literal">input()</code> and have the user type in the password. It may be inconvenient to have to enter a password each time you run your program, but this approach will prevent you from leaving your password in an unencrypted file on your computer where a hacker or laptop thief could easily get it.</em></span></p></div></div><div class="sect2" title="Sending an Email"><div class="titlepage"><div><div><h2 class="title"><a id="sending_an_email"/>Sending an Email</h2></div></div></div><p>Once you are logged in to your email provider’s SMTP server, you can call the <code class="literal">sendmail()</code> method to actually send the email. The <code class="literal">sendmail()</code> method call looks like this:</p><a id="pro_id00570"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>smtpObj.sendmail('</strong></span> <span class="emphasis"><em><span class="strong"><strong>my_email_address@gmail.com</strong></span></em></span> <span class="strong"><strong>', '</strong></span> <span class="emphasis"><em><span class="strong"><strong>recipient@example.com</strong></span></em></span> <span class="strong"><strong>',</strong></span>
<span class="strong"><strong>'Subject: So long.\nDear Alice, so long and thanks for all the fish. Sincerely,</strong></span>
<span class="strong"><strong>Bob')</strong></span>
{}</pre><p>The <code class="literal">sendmail()</code> method requires three arguments.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Your email address as a string (for the email’s “from” address)</p></li><li class="listitem"><p>The recipient’s email address as a string or a list of strings for multiple recipients (for the “to” address)</p></li><li class="listitem"><p>The email body as a string</p></li></ul></div><p>The start of the email body string <span class="emphasis"><em>must</em></span> begin with <code class="literal">'Subject: \n'</code> for the subject line of the email. The <code class="literal">'\n'</code> newline character separates the subject line from the main body of the email.</p><p>The return value from <code class="literal">sendmail()</code> is a dictionary. There will be one key-value pair in the dictionary for each recipient for whom email delivery <span class="emphasis"><em>failed</em></span>. An empty dictionary means all recipients were <span class="emphasis"><em>successfully</em></span> sent the email.</p></div><div class="sect2" title="Disconnecting from the SMTP Server"><div class="titlepage"><div><div><h2 class="title"><a id="disconnecting_from_the_smtp_server"/>Disconnecting from the SMTP Server</h2></div></div></div><p><a id="iddle1390" class="indexterm"/><a id="iddle1393" class="indexterm"/><a id="iddle1397" class="indexterm"/><a id="iddle1699" class="indexterm"/><a id="iddle1706" class="indexterm"/><a id="iddle1744" class="indexterm"/><a id="iddle2267" class="indexterm"/><a id="iddle2273" class="indexterm"/><a id="iddle2447" class="indexterm"/>Be sure to call the <code class="literal">quit()</code> method when you are done sending emails. This will disconnect your program from the SMTP server.</p><a id="pro_id00571"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>smtpObj.quit()</strong></span>
(221, b'2.0.0 closing connection ko10sm23097611pbd.52 - gsmtp')</pre><p>The <code class="literal">221</code> in the return value means the session is ending.</p><p>To review all the steps for connecting and logging in to the server, sending email, and disconnection, see <a class="xref" href="ch16.html#sending_email" title="Sending Email">Sending Email</a>.</p></div></div><div class="sect1" title="IMAP"><div class="titlepage"><div><div><h1 class="title"><a id="imap"/>IMAP</h1></div></div></div><p>Just as SMTP is the protocol for sending email, the <span class="emphasis"><em>Internet Message Access Protocol (IMAP)</em></span> specifies how to communicate with an email provider’s server to retrieve emails sent to your email address. Python comes with an <code class="literal">imaplib</code> module, but in fact the third-party <code class="literal">imapclient</code> module is easier to use. This chapter provides an introduction to using IMAPClient; the full documentation is at <span class="emphasis"><em><a class="ulink" href="http://imapclient.readthedocs.org/">http://imapclient.readthedocs.org/</a></em></span>.</p><p>The <code class="literal">imapclient</code> module downloads emails from an IMAP server in a rather complicated format. Most likely, you’ll want to convert them from this format into simple string values. The <code class="literal">pyzmail</code> module does the hard job of parsing these email messages for you. You can find the complete documentation for PyzMail at <span class="emphasis"><em><a class="ulink" href="http://www.magiksys.net/pyzmail/">http://www.magiksys.net/pyzmail/</a></em></span>.</p><p>Install <code class="literal">imapclient</code> and <code class="literal">pyzmail</code> from a Terminal window. Appendix A has steps on how to install third-party modules.</p></div><div class="sect1" title="Retrieving and Deleting Emails with IMAP"><div class="titlepage"><div><div><h1 class="title"><a id="retrieving_and_deleting_emails_with_imap"/>Retrieving and Deleting Emails with IMAP</h1></div></div></div><p>Finding and retrieving an email in Python is a multistep process that requires both the <code class="literal">imapclient</code> and <code class="literal">pyzmail</code> third-party modules. Just to give you an overview, here’s a full example of logging in to an IMAP server, searching for emails, fetching them, and then extracting the text of the email messages from them.</p><a id="pro_id00572"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>import imapclient</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>imapObj = imapclient.IMAPClient('imap.gmail.com', ssl=True)</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>imapObj.login('</strong></span> <span class="emphasis"><em><span class="strong"><strong>my_email_address@gmail.com</strong></span></em></span> <span class="strong"><strong>', '</strong></span> <span class="emphasis"><em><span class="strong"><strong>MY_SECRET_PASSWORD</strong></span></em></span> <span class="strong"><strong>')</strong></span>
'my_email_address@gmail.com Jane Doe authenticated (Success)'
&gt;&gt;&gt; <span class="strong"><strong>imapObj.select_folder('INBOX', readonly=True)</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>UIDs = imapObj.search(['SINCE 05-Jul-2014'])</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>UIDs</strong></span>
[40032, 40033, 40034, 40035, 40036, 40037, 40038, 40039, 40040, 40041]
&gt;&gt;&gt; <span class="strong"><strong>rawMessages = imapObj.fetch([40041], ['BODY[]', 'FLAGS'])</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>import pyzmail</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>message = pyzmail.PyzMessage.factory(rawMessages[40041]['BODY[]'])</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>message.get_subject()</strong></span>
'Hello!'
&gt;&gt;&gt; <span class="strong"><strong>message.get_addresses('from')</strong></span>
[('Edward Snowden', 'esnowden@nsa.gov')]
&gt;&gt;&gt; <span class="strong"><strong>message.get_addresses('to')</strong></span>
[(Jane Doe', 'jdoe@example.com')]
&gt;&gt;&gt; <span class="strong"><strong>message.get_addresses('cc')</strong></span>
[]
&gt;&gt;&gt; <span class="strong"><strong>message.get_addresses('bcc')</strong></span>
[]
&gt;&gt;&gt; <span class="strong"><strong>message.text_part != None</strong></span>
True
&gt;&gt;&gt; <span class="strong"><strong>message.text_part.get_payload().decode(message.text_part.charset)</strong></span>
'Follow the money.\r\n\r\n-Ed\r\n'
&gt;&gt;&gt; <span class="strong"><strong>message.html_part != None</strong></span>
True
&gt;&gt;&gt; <span class="strong"><strong>message.html_part.get_payload().decode(message.html_part.charset)</strong></span>
'&lt;div dir="ltr"&gt;&lt;div&gt;So long, and thanks for all the fish!&lt;br&gt;&lt;br&gt;&lt;/div&gt;-
Al&lt;br&gt;&lt;/div&gt;\r\n'
&gt;&gt;&gt; <span class="strong"><strong>imapObj.logout()</strong></span></pre><p><a id="iddle1100" class="indexterm"/><a id="iddle1192" class="indexterm"/><a id="iddle1608" class="indexterm"/><a id="iddle1654" class="indexterm"/><a id="iddle1707" class="indexterm"/><a id="iddle2050" class="indexterm"/><a id="iddle2645" class="indexterm"/><a id="iddle2735" class="indexterm"/>You don’t have to memorize these steps. After we go through each step in detail, you can come back to this overview to refresh your memory.</p><div class="sect2" title="Connecting to an IMAP Server"><div class="titlepage"><div><div><h2 class="title"><a id="connecting_to_an_imap_server"/>Connecting to an IMAP Server</h2></div></div></div><p>Just like you needed an <code class="literal">SMTP</code> object to connect to an SMTP server and send email, you need an <code class="literal">IMAPClient</code> object to connect to an IMAP server and receive email. First you’ll need the domain name of your email provider’s IMAP server. This will be different from the SMTP server’s domain name. <a class="xref" href="ch16.html#email_providers_and_their_imap_servers" title="Table 16-2. Email Providers and Their IMAP Servers">Table 16-2</a> lists the IMAP servers for several popular email providers.</p><div class="table"><a id="email_providers_and_their_imap_servers"/><p class="title">Table 16-2. Email Providers and Their IMAP Servers</p><div class="table-contents"><table summary="Email Providers and Their IMAP Servers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Provider</p></th><th style="border-bottom: 0.5pt solid ; " valign="top"><p>IMAP server domain name</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Gmail</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>imap.gmail.com</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Outlook.com/Hotmail.com</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>imap-mail.outlook.com</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Yahoo Mail</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>imap.mail.yahoo.com</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>AT&amp;T</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>imap.mail.att.net</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Comcast</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p><span class="emphasis"><em>imap.comcast.net</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; " valign="top"><p>Verizon</p></td><td style="" valign="top"><p><span class="emphasis"><em>incoming.verizon.net</em></span></p></td></tr></tbody></table></div></div><p>Once you have the domain name of the IMAP server, call the <code class="literal">imapclient.IMAPClient()</code> function to create an <code class="literal">IMAPClient</code> object. Most email providers require SSL encryption, so pass the <code class="literal">ssl=True</code> keyword argument. Enter the following into the interactive shell (using your provider’s domain name):</p><a id="pro_id00573"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>import imapclient</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>imapObj = imapclient.IMAPClient('imap.gmail.com', ssl=True)</strong></span></pre><p><a id="iddle1387" class="indexterm"/><a id="iddle1389" class="indexterm"/><a id="iddle1395" class="indexterm"/><a id="iddle1703" class="indexterm"/><a id="iddle1704" class="indexterm"/><a id="iddle1705" class="indexterm"/><a id="iddle1829" class="indexterm"/><a id="iddle1874" class="indexterm"/><a id="iddle2387" class="indexterm"/>In all of the interactive shell examples in the following sections, the <code class="literal">imapObj</code> variable will contain an <code class="literal">IMAPClient</code> object returned from the <code class="literal">imapclient.IMAPClient()</code> function. In this context, a <span class="emphasis"><em>client</em></span> is the object that connects to the server.</p></div><div class="sect2" title="Logging in to the IMAP Server"><div class="titlepage"><div><div><h2 class="title"><a id="logging_in_to_the_imap_server"/>Logging in to the IMAP Server</h2></div></div></div><p>Once you have an <code class="literal">IMAPClient</code> object, call its <code class="literal">login()</code> method, passing in the username (this is usually your email address) and password as strings.</p><a id="pro_id00574"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>imapObj.login('</strong></span> <span class="emphasis"><em><span class="strong"><strong>my_email_address@gmail.com</strong></span></em></span> <span class="strong"><strong>', '</strong></span> <span class="emphasis"><em><span class="strong"><strong>MY_SECRET_PASSWORD</strong></span></em></span> <span class="strong"><strong>')</strong></span>
'my_email_address@gmail.com Jane Doe authenticated (Success)'</pre><div class="warning" title="Warning"><h3 class="title"><a id="ch16note04"/>Warning</h3><p><span class="emphasis"><em>Remember, never write a password directly into your code! Instead, design your program to accept the password returned from <code class="literal">input()</code></em></span>.</p></div><p>If the IMAP server rejects this username/password combination, Python will raise an <code class="literal">imaplib.error</code> exception. For Gmail accounts, you may need to use an application-specific password; for more details, see <a class="xref" href="ch16.html#gmailapostrophes_application-specific_pa" title="Gmail’s Application-Specific Passwords">Gmail’s Application-Specific Passwords</a>.</p></div><div class="sect2" title="Searching for Email"><div class="titlepage"><div><div><h2 class="title"><a id="searching_for_email"/>Searching for Email</h2></div></div></div><p>Once you’re logged on, actually retrieving an email that you’re interested in is a two-step process. First, you must select a folder you want to search through. Then, you must call the <code class="literal">IMAPClient</code> object’s <code class="literal">search()</code> method, passing in a string of IMAP search keywords.</p><div class="sect3" title="Selecting a Folder"><div class="titlepage"><div><div><h3 class="title"><a id="selecting_a_folder"/>Selecting a Folder</h3></div></div></div><p>Almost every account has an <code class="literal">INBOX</code> folder by default, but you can also get a list of folders by calling the <code class="literal">IMAPClient</code> object’s <code class="literal">list_folders()</code> method. This returns a list of tuples. Each tuple contains information about a single folder. Continue the interactive shell example by entering the following:</p><a id="pro_id00575"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>import pprint</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>pprint.pprint(imapObj.list_folders())</strong></span>
[(('\\HasNoChildren',), '/', 'Drafts'),
 (('\\HasNoChildren',), '/', 'Filler'),
 (('\\HasNoChildren',), '/', 'INBOX'),
 (('\\HasNoChildren',), '/', 'Sent'),
<span class="emphasis"><em>--snip-</em></span>
 (('\\HasNoChildren', '\\Flagged'), '/', '[Gmail]/Starred'),
 (('\\HasNoChildren', '\\Trash'), '/', '[Gmail]/Trash')]</pre><p><a id="iddle1083" class="indexterm"/><a id="iddle1117" class="indexterm"/><a id="iddle1125" class="indexterm"/><a id="iddle2017" class="indexterm"/><a id="iddle2397" class="indexterm"/><a id="iddle2431" class="indexterm"/><a id="iddle2529" class="indexterm"/><a id="iddle2555" class="indexterm"/>This is what your output might look like if you have a Gmail account. (Gmail calls its folders <span class="emphasis"><em>labels</em></span>, but they work the same way as folders.) The three values in each of the tuples—for example, <code class="literal">(('\\HasNoChildren',), '/', 'INBOX')</code>—are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A tuple of the folder’s flags. (Exactly what these flags represent is beyond the scope of this book, and you can safely ignore this field.)</p></li><li class="listitem"><p>The delimiter used in the name string to separate parent folders and subfolders.</p></li><li class="listitem"><p>The full name of the folder.</p></li></ul></div><p>To select a folder to search through, pass the folder’s name as a string into the <code class="literal">IMAPClient</code> object’s <code class="literal">select_folder()</code> method.</p><a id="pro_id00576"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>imapObj.select_folder('INBOX', readonly=True)</strong></span></pre><p>You can ignore <code class="literal">select_folder()</code>’s return value. If the selected folder does not exist, Python will raise an <code class="literal">imaplib.error</code> exception.</p><p>The <code class="literal">readonly=True</code> keyword argument prevents you from accidentally making changes or deletions to any of the emails in this folder during the subsequent method calls. Unless you <span class="emphasis"><em>want</em></span> to delete emails, it’s a good idea to always set <code class="literal">readonly</code> to <code class="literal">True</code>.</p></div><div class="sect3" title="Performing the Search"><div class="titlepage"><div><div><h3 class="title"><a id="performing_the_search"/>Performing the Search</h3></div></div></div><p>With a folder selected, you can now search for emails with the <code class="literal">IMAPClient</code> object’s <code class="literal">search()</code> method. The argument to <code class="literal">search()</code> is a list of strings, each formatted to the IMAP’s search keys. <a class="xref" href="ch16.html#imap_search_keys" title="Table 16-3. IMAP Search Keys">Table 16-3</a> describes the various search keys.</p><div class="table"><a id="imap_search_keys"/><p class="title">Table 16-3. IMAP Search Keys</p><div class="table-contents"><table summary="IMAP Search Keys" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Search key</p></th><th style="border-bottom: 0.5pt solid ; " valign="top"><p>Meaning</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'ALL'</code></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns all messages in the folder. You may run in to <code class="literal">imaplib</code> size limits if you request all the messages in a large folder. See <a class="xref" href="ch16.html#size_limits" title="Size Limits">Size Limits</a>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'BEFORE</code> <span class="emphasis"><em><code class="literal">date'</code></em></span>, <code class="literal">'ON</code> <span class="emphasis"><em><code class="literal">date'</code></em></span>, <code class="literal">'SINCE</code> <span class="emphasis"><em><code class="literal">date'</code></em></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>These three search keys return, respectively, messages that were received by the IMAP server before, on, or after the given <span class="emphasis"><em><code class="literal">date</code></em></span>. The date must be formatted like <code class="literal">05-Jul-2015</code>. Also, while <code class="literal">'SINCE 05-Jul-2015'</code> will match messages on and after July 5, <code class="literal">'BEFORE 05-Jul-2015'</code> will match only messages before July 5 but not on July 5 itself.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'SUBJECT</code> <span class="emphasis"><em><code class="literal">string'</code></em></span>, <code class="literal">'BODY</code> <span class="emphasis"><em><code class="literal">string'</code></em></span>, <code class="literal">'TEXT</code> <span class="emphasis"><em><code class="literal">string'</code></em></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns messages where <span class="emphasis"><em><code class="literal">string</code></em></span> is found in the subject, body, or either, respectively. If <span class="emphasis"><em><code class="literal">string</code></em></span> has spaces in it, then enclose it with double quotes: <code class="literal">'TEXT "search with spaces"'</code>.<a id="iddle1086" class="indexterm"/><a id="iddle1114" class="indexterm"/><a id="iddle1158" class="indexterm"/><a id="iddle1304" class="indexterm"/><a id="iddle1357" class="indexterm"/><a id="iddle1509" class="indexterm"/><a id="iddle1568" class="indexterm"/><a id="iddle1792" class="indexterm"/><a id="iddle2014" class="indexterm"/><a id="iddle2035" class="indexterm"/><a id="iddle2395" class="indexterm"/><a id="iddle2442" class="indexterm"/><a id="iddle2580" class="indexterm"/><a id="iddle2612" class="indexterm"/><a id="iddle2613" class="indexterm"/><a id="iddle2616" class="indexterm"/><a id="iddle2617" class="indexterm"/><a id="iddle2624" class="indexterm"/></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'FROM</code> <span class="emphasis"><em><code class="literal">string'</code></em></span>, <code class="literal">'TO</code> <span class="emphasis"><em><code class="literal">string'</code></em></span>, <code class="literal">'CC</code> <span class="emphasis"><em><code class="literal">string'</code></em></span>, <code class="literal">'BCC</code> <span class="emphasis"><em><code class="literal">string'</code></em></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns all messages where <span class="emphasis"><em><code class="literal">string</code></em></span> is found in the “from” emailaddress, “to” addresses, “cc” (carbon copy) addresses, or “bcc” (blind carbon copy) addresses, respectively. If there are multiple email addresses in <span class="emphasis"><em><code class="literal">string</code></em></span>, then separate them with spaces and enclose them all with double quotes: <code class="literal">'CC</code> <span class="emphasis"><em><code class="literal">"firstcc@example.com secondcc@example.com"'</code></em></span>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'SEEN'</code>, <code class="literal">'UNSEEN'</code></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns all messages with and without the <span class="emphasis"><em>\Seen</em></span> flag, respectively. An email obtains the <span class="emphasis"><em>\Seen</em></span> flag if it has been accessed with a <code class="literal">fetch()</code> method call (described later) or if it is clicked when you’re checking your email in an email program or web browser. It’s more common to say the email has been “read” rather than “seen,” but they mean the same thing.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'ANSWERED'</code>, <code class="literal">'UNANSWERED'</code></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns all messages with and without the <span class="emphasis"><em>\Answered</em></span> flag, respectively. A message obtains the <span class="emphasis"><em>\Answered</em></span> flag when it is replied to.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'DELETED'</code>, <code class="literal">'UNDELETED'</code></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns all messages with and without the <span class="emphasis"><em>\Deleted</em></span> flag, respectively. Email messages deleted with the <code class="literal">delete_messages()</code> method are given the <span class="emphasis"><em>\Deleted</em></span> flag but are not permanently deleted until the <code class="literal">expunge()</code> method is called (see <a class="xref" href="ch16.html#deleting_emails" title="Deleting Emails">Deleting Emails</a>). Note that some email providers, such as Gmail, automatically expunge emails.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'DRAFT'</code>, <code class="literal">'UNDRAFT'</code></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns all messages with and without the <span class="emphasis"><em>\Draft</em></span> flag, respectively. Draft messages are usually kept in a separate <code class="literal">Drafts</code> folder rather than in the <code class="literal">INBOX</code> folder.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'FLAGGED'</code>, <code class="literal">'UNFLAGGED'</code></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns all messages with and without the <span class="emphasis"><em>\Flagged</em></span> flag, respectively. This flag is usually used to mark email messages as “Important” or “Urgent.”</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'LARGER</code> <span class="emphasis"><em><code class="literal">N'</code></em></span>, <code class="literal">'SMALLER</code> <span class="emphasis"><em><code class="literal">N'</code></em></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns all messages larger or smaller than <span class="emphasis"><em><code class="literal">N</code></em></span> bytes, respectively.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><code class="literal">'NOT</code> <span class="emphasis"><em><code class="literal">search-key'</code></em></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Returns the messages that <span class="emphasis"><em><code class="literal">search-key</code></em></span> would <span class="emphasis"><em>not</em></span> have returned.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " valign="top"><p><code class="literal">'OR</code> <span class="emphasis"><em><code class="literal">search-key1 search-key2'</code></em></span></p></td><td style="" valign="top"><p>Returns the messages that match <span class="emphasis"><em>either</em></span> the first or second <span class="emphasis"><em><code class="literal">search-key</code></em></span>.</p></td></tr></tbody></table></div></div><p>Note that some IMAP servers may have slightly different implementations for how they handle their flags and search keys. It may require some experimentation in the interactive shell to see exactly how they behave.</p><p>You can pass multiple IMAP search key strings in the list argument to the <code class="literal">search()</code> method. The messages returned are the ones that match <span class="emphasis"><em>all</em></span> the search keys. If you want to match <span class="emphasis"><em>any</em></span> of the search keys, use the <code class="literal">OR</code> search key. For the <code class="literal">NOT</code> and <code class="literal">OR</code> search keys, one and two complete search keys follow the <code class="literal">NOT</code> and <code class="literal">OR</code>, respectively.</p><p>Here are some example <code class="literal">search()</code> method calls along with their meanings:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p title="imapObj.search(['ALL'])"><span class="title"><strong><span class="strong"><strong><code class="literal">imapObj.search(['ALL'])</code></strong></span></strong></span>. Returns every message in the currently selected folder.</p></li><li class="listitem"><p title="imapObj.search(['ON 05-Jul-2015'])"><span class="title"><strong><span class="strong"><strong><code class="literal">imapObj.search(['ON 05-Jul-2015'])</code></strong></span></strong></span>. Returns every message sent on July 5, 2015.</p></li><li class="listitem"><p title="imapObj.search(['SINCE 01-Jan-2015', 'BEFORE 01-Feb-2015', 'UNSEEN'])"><span class="title"><strong><span class="strong"><strong><code class="literal">imapObj.search(['SINCE 01-Jan-2015', 'BEFORE 01-Feb-2015', 'UNSEEN'])</code></strong></span></strong></span>. <a id="iddle1469" class="indexterm"/>Returns every message sent in January 2015 that is unread. (Note that this means <span class="emphasis"><em>on and after</em></span> January 1 and up to <span class="emphasis"><em>but not including</em></span> February 1.)</p></li><li class="listitem"><p title="imapObj.search(['SINCE 01-Jan-2015', 'FROM alice@example.com'])"><span class="title"><strong><span class="strong"><strong><code class="literal">imapObj.search(['SINCE 01-Jan-2015', 'FROM alice@example.com'])</code></strong></span></strong></span>. Returns every message from <span class="emphasis"><em><span class="email"><a class="email" href="mailto:alice@example.com">alice@example.com</a></span></em></span> sent since the start of 2015.</p></li><li class="listitem"><p title="imapObj.search(['SINCE 01-Jan-2015', 'NOT FROM alice@example.com'])"><span class="title"><strong><span class="strong"><strong><code class="literal">imapObj.search(['SINCE 01-Jan-2015', 'NOT FROM alice@example.com'])</code></strong></span></strong></span>. Returns every message sent from everyone except <span class="emphasis"><em><span class="email"><a class="email" href="mailto:alice@example.com">alice@example.com</a></span></em></span> since the start of 2015.</p></li><li class="listitem"><p title="imapObj.search(['OR FROM alice@example.com FROM bob@example.com'])"><span class="title"><strong><span class="strong"><strong><code class="literal">imapObj.search(['OR FROM alice@example.com FROM bob@example.com'])</code></strong></span></strong></span>. Returns every message ever sent from <span class="emphasis"><em><span class="email"><a class="email" href="mailto:alice@example.com">alice@example.com</a></span></em></span> or <span class="emphasis"><em><span class="email"><a class="email" href="mailto:bob@example.com">bob@example.com</a></span></em></span>.</p></li><li class="listitem"><p title="imapObj.search(['FROM alice@example.com', 'FROM bob@example.com'])"><span class="title"><strong><span class="strong"><strong><code class="literal">imapObj.search(['FROM alice@example.com', 'FROM bob@example.com'])</code></strong></span></strong></span>. Trick example! This search will never return any messages, because messages must match <span class="emphasis"><em>all</em></span> search keywords. Since there can be only one “from” address, it is impossible for a message to be from both <span class="emphasis"><em><span class="email"><a class="email" href="mailto:alice@example.com">alice@example.com</a></span></em></span> and <span class="emphasis"><em><span class="email"><a class="email" href="mailto:bob@example.com">bob@example.com</a></span></em></span>.</p></li></ul></div><p>The <code class="literal">search()</code> method doesn’t return the emails themselves but rather unique IDs (UIDs) for the emails, as integer values. You can then pass these UIDs to the <code class="literal">fetch()</code> method to obtain the email content.</p><p>Continue the interactive shell example by entering the following:</p><a id="pro_id00577"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>UIDs = imapObj.search(['SINCE 05-Jul-2015'])</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>UIDs</strong></span>
[40032, 40033, 40034, 40035, 40036, 40037, 40038, 40039, 40040, 40041]</pre><p>Here, the list of message IDs (for messages received July 5 onward) returned by <code class="literal">search()</code> is stored in <code class="literal">UIDs</code>. The list of UIDs returned on your computer will be different from the ones shown here; they are unique to a particular email account. When you later pass UIDs to other function calls, use the UID values you received, not the ones printed in this book’s examples.</p></div><div class="sect3" title="Size Limits"><div class="titlepage"><div><div><h3 class="title"><a id="size_limits"/>Size Limits</h3></div></div></div><p>If your search matches a large number of email messages, Python might raise an exception that says <code class="literal">imaplib.error: got more than 10000 bytes</code>. When this happens, you will have to disconnect and reconnect to the IMAP server and try again.</p><p>This limit is in place to prevent your Python programs from eating up too much memory. Unfortunately, the default size limit is often too small. You can change this limit from 10,000 bytes to 10,000,000 bytes by running this code:</p><a id="pro_id00578"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>import imaplib</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>imaplib._MAXLINE = 10000000</strong></span></pre><p>This should prevent this error message from coming up again. You may want to make these two lines part of every IMAP program you write.</p><div class="sidebar"><a id="using_im_apclientapostrophes_gmailunders"/><p class="title">Using Imapclient’s Gmail_Search( ) Method</p><p><a id="iddle1388" class="indexterm"/><a id="iddle1392" class="indexterm"/><a id="iddle1394" class="indexterm"/><a id="iddle1470" class="indexterm"/><a id="iddle1609" class="indexterm"/><a id="iddle1702" class="indexterm"/>If you are logging in to the <span class="emphasis"><em>imap.gmail.com</em></span> server to access a Gmail account, the <code class="literal">IMAPClient</code> object provides an extra search function that mimics the search bar at the top of the Gmail web page, as highlighted in <a class="xref" href="ch16.html#search_bar_at_the_top_of_the_gmail_web_p" title="Figure 16-1. The search bar at the top of the Gmail web page">Figure 16-1</a>.</p><div class="figure"><a id="search_bar_at_the_top_of_the_gmail_web_p"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00078"/><img src="figs/web/16fig01.png.jpg" alt="The search bar at the top of the Gmail web page"/></div></div><p class="title">Figure 16-1. The search bar at the top of the Gmail web page</p></div><p>Instead of searching with IMAP search keys, you can use Gmail’s more sophisticated search engine. Gmail does a good job of matching closely related words (for example, a search for <span class="emphasis"><em>driving</em></span> will also match <span class="emphasis"><em>drive</em></span> and <span class="emphasis"><em>drove</em></span>) and sorting the search results by most significant matches. You can also use Gmail’s advanced search operators (see <span class="emphasis"><em><a class="ulink" href="http://nostarch.com/automatestuff/">http://nostarch.com/automatestuff/</a></em></span> for more information). If you are logging in to a Gmail account, pass the search terms to the <code class="literal">gmail_search()</code> method instead of the <code class="literal">search()</code> method, like in the following interactive shell example:</p><a id="pro_id00579"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>UIDs = imapObj.gmail_search('meaning of life')</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>UIDs</strong></span>
[42]</pre><p>Ah, yes—<span class="emphasis"><em>there’s</em></span> that email with the meaning of life! I was looking for that.</p></div></div></div><div class="sect2" title="Fetching an Email and Marking It As Read"><div class="titlepage"><div><div><h2 class="title"><a id="fetching_an_email_and_marking_it_as_read"/>Fetching an Email and Marking It As Read</h2></div></div></div><p>Once you have a list of UIDs, you can call the <code class="literal">IMAPClient</code> object’s <code class="literal">fetch()</code> method to get the actual email content.</p><p>The list of UIDs will be <code class="literal">fetch()</code>’s first argument. The second argument should be the list <code class="literal">['BODY[]']</code>, which tells <code class="literal">fetch()</code> to download all the body content for the emails specified in your UID list.</p><p><a id="iddle1391" class="indexterm"/><a id="iddle2268" class="indexterm"/><a id="iddle2269" class="indexterm"/><a id="iddle2418" class="indexterm"/>Let’s continue our interactive shell example.</p><a id="pro_id00580"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>rawMessages = imapObj.fetch(UIDs, ['BODY[]'])</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>import pprint</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>pprint.pprint(rawMessages)</strong></span>
{40040: {'BODY[]': 'Delivered-To: my_email_address@gmail.com\r\n'
                   'Received: by 10.76.71.167 with SMTP id '
<span class="emphasis"><em>--snip--</em></span>
                   '\r\n'
                   '------=_Part_6000970_707736290.1404819487066--\r\n',
         'SEQ': 5430}}</pre><p>Import <code class="literal">pprint</code> and pass the return value from <code class="literal">fetch()</code>, stored in the variable <code class="literal">rawMessages</code>, to <code class="literal">pprint.pprint()</code> to “pretty print” it, and you’ll see that this return value is a nested dictionary of messages with UIDs as the keys. Each message is stored as a dictionary with two keys: <code class="literal">'BODY[]'</code> and <code class="literal">'SEQ'</code>. The <code class="literal">'BODY[]'</code> key maps to the actual body of the email. The <code class="literal">'SEQ'</code> key is for a <span class="emphasis"><em>sequence number</em></span>, which has a similar role to the UID. You can safely ignore it.</p><p>As you can see, the message content in the <code class="literal">'BODY[]'</code> key is pretty unintelligible. It’s in a format called RFC 822, which is designed for IMAP servers to read. But you don’t need to understand the RFC 822 format; later in this chapter, the <code class="literal">pyzmail</code> module will make sense of it for you.</p><p>When you selected a folder to search through, you called <code class="literal">select_folder()</code> with the <code class="literal">readonly=True</code> keyword argument. Doing this will prevent you from accidentally deleting an email—but it also means that emails will not get marked as read if you fetch them with the <code class="literal">fetch()</code> method. If you <span class="emphasis"><em>do</em></span> want emails to be marked as read when you fetch them, you will need to pass <code class="literal">readonly=False</code> to <code class="literal">select_folder()</code>. If the selected folder is already in readonly mode, you can reselect the current folder with another call to <code class="literal">select_folder()</code>, this time with the <code class="literal">readonly=False</code> keyword argument:</p><a id="pro_id00581"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>imapObj.select_folder('INBOX', readonly=False)</strong></span></pre></div><div class="sect2" title="Getting Email Addresses from a Raw Message"><div class="titlepage"><div><div><h2 class="title"><a id="getting_email_addresses_from_a_raw_messa"/>Getting Email Addresses from a Raw Message</h2></div></div></div><p>The raw messages returned from the <code class="literal">fetch()</code> method still aren’t very useful to people who just want to read their email. The <code class="literal">pyzmail</code> module parses these raw messages and returns them as <code class="literal">PyzMessage</code> objects, which make the subject, body, “To” field, “From” field, and other sections of the email easily accessible to your Python code.</p><p>Continue the interactive shell example with the following (using UIDs from your own email account, not the ones shown here):</p><a id="pro_id00582"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>import pyzmail</strong></span>
&gt;&gt;&gt; <span class="strong"><strong>message = pyzmail.PyzMessage.factory(rawMessages[40041]['BODY[]'])</strong></span></pre><p>First, import <code class="literal">pyzmail</code>. Then, to create a <code class="literal">PyzMessage</code> object of an email, call the <code class="literal">pyzmail.PyzMessage.factory()</code> function and pass it the <code class="literal">'BODY[]'</code> section of the raw message. Store the result in <code class="literal">message</code>. Now <code class="literal">message</code> contains <a id="iddle1298" class="indexterm"/><a id="iddle1584" class="indexterm"/><a id="iddle1595" class="indexterm"/><a id="iddle1602" class="indexterm"/>a <code class="literal">PyzMessage</code> object, which has several methods that make it easy to get the email’s subject line, as well as all sender and recipient addresses. The <code class="literal">get_subject()</code> method returns the subject as a simple string value. The <code class="literal">get_addresses()</code> method returns a list of addresses for the field you pass it. For example, the method calls might look like this:</p><a id="pro_id00583"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>message.get_subject()</strong></span>
'Hello!'
&gt;&gt;&gt; <span class="strong"><strong>message.get_addresses('from')</strong></span>
[('Edward Snowden', 'esnowden@nsa.gov')]
&gt;&gt;&gt; <span class="strong"><strong>message.get_addresses('to')</strong></span>
[(Jane Doe', 'my_email_address@gmail.com')]
&gt;&gt;&gt; <span class="strong"><strong>message.get_addresses('cc')</strong></span>
[]
&gt;&gt;&gt; <span class="strong"><strong>message.get_addresses('bcc')</strong></span>
[]</pre><p>Notice that the argument for <code class="literal">get_addresses()</code> is <code class="literal">'from'</code>, <code class="literal">'to'</code>, <code class="literal">'cc'</code>, or <code class="literal">'bcc'</code>. The return value of <code class="literal">get_addresses()</code> is a list of tuples. Each tuple contains two strings: The first is the name associated with the email address, and the second is the email address itself. If there are no addresses in the requested field, <code class="literal">get_addresses()</code> returns a blank list. Here, the <code class="literal">'cc'</code> carbon copy and <code class="literal">'bcc'</code> blind carbon copy fields both contained no addresses and so returned empty lists.</p></div><div class="sect2" title="Getting the Body from a Raw Message"><div class="titlepage"><div><div><h2 class="title"><a id="getting_the_body_from_a_raw_message"/>Getting the Body from a Raw Message</h2></div></div></div><p>Emails can be sent as plaintext, HTML, or both. Plaintext emails contain only text, while HTML emails can have colors, fonts, images, and other features that make the email message look like a small web page. If an email is only plaintext, its <code class="literal">PyzMessage</code> object will have its <code class="literal">html_part</code> attributes set to <code class="literal">None</code>. Likewise, if an email is only HTML, its <code class="literal">PyzMessage</code> object will have its <code class="literal">text_part</code> attribute set to <code class="literal">None</code>.</p><p>Otherwise, the <code class="literal">text_part</code> or <code class="literal">html_part</code> value will have a <code class="literal">get_payload()</code> method that returns the email’s body as a value of the <span class="emphasis"><em>bytes</em></span> data type. (The bytes data type is beyond the scope of this book.) But this <span class="emphasis"><em>still</em></span> isn’t a string value that we can use. Ugh! The last step is to call the <code class="literal">decode()</code> method on the bytes value returned by <code class="literal">get_payload()</code>. The <code class="literal">decode()</code> method takes one argument: the message’s character encoding, stored in the <code class="literal">text_part.charset</code> or <code class="literal">html_part.charset</code> attribute. This, finally, will return the string of the email’s body.</p><p>Continue the interactive shell example by entering the following:</p><a id="pro_id00584"/><pre class="programlisting">➊ &gt;&gt;&gt; <span class="strong"><strong>message.text_part != None</strong></span>
   True
   &gt;&gt;&gt; <span class="strong"><strong>message.text_part.get_payload().decode(message.text_part.charset)</strong></span>
➋ 'So long, and thanks for all the fish!\r\n\r\n-Al\r\n'
➌ &gt;&gt;&gt; <span class="strong"><strong>message.html_part != None</strong></span>
   True
➍ &gt;&gt;&gt; <span class="strong"><strong>message.html_part.get_payload().decode(message.html_part.charset)</strong></span>
   '&lt;div dir="ltr"&gt;&lt;div&gt;So long, and thanks for all the fish!&lt;br&gt;&lt;br&gt;&lt;/div&gt;-Al
   &lt;br&gt;&lt;/div&gt;\r\n'</pre><p><a id="iddle1305" class="indexterm"/><a id="iddle1385" class="indexterm"/><a id="iddle1386" class="indexterm"/><a id="iddle1462" class="indexterm"/><a id="iddle1700" class="indexterm"/><a id="iddle1701" class="indexterm"/><a id="iddle1881" class="indexterm"/>The email we’re working with has both plaintext and HTML content, so the <code class="literal">PyzMessage</code> object stored in <code class="literal">message</code> has <code class="literal">text_part</code> and <code class="literal">html_part</code> attributes not equal to <code class="literal">None</code> ➊ ➌. Calling <code class="literal">get_payload()</code> on the message’s <code class="literal">text_part</code> and then calling <code class="literal">decode()</code> on the bytes value returns a string of the text version of the email ➋. Using <code class="literal">get_payload()</code> and <code class="literal">decode()</code> with the message’s <code class="literal">html_part</code> returns a string of the HTML version of the email ➍.</p></div><div class="sect2" title="Deleting Emails"><div class="titlepage"><div><div><h2 class="title"><a id="deleting_emails"/>Deleting Emails</h2></div></div></div><p>To delete emails, pass a list of message UIDs to the <code class="literal">IMAPClient</code> object’s <code class="literal">delete_messages()</code> method. This marks the emails with the <span class="emphasis"><em>\Deleted</em></span> flag. Calling the <code class="literal">expunge()</code> method will permanently delete all emails with the <span class="emphasis"><em>\Deleted</em></span> flag in the currently selected folder. Consider the following interactive shell example:</p><a id="pro_id00585"/><pre class="programlisting">➊ &gt;&gt;&gt; <span class="strong"><strong>imapObj.select_folder('INBOX', readonly=False)</strong></span>
➋ &gt;&gt;&gt; <span class="strong"><strong>UIDs = imapObj.search(['ON 09-Jul-2015'])</strong></span>
   &gt;&gt;&gt; <span class="strong"><strong>UIDs</strong></span>
   [40066]
   &gt;&gt;&gt; <span class="strong"><strong>imapObj.delete_messages(UIDs)</strong></span>
➌ {40066: ('\\Seen', '\\Deleted')}
   &gt;&gt;&gt; <span class="strong"><strong>imapObj.expunge()</strong></span>
   ('Success', [(5452, 'EXISTS')])</pre><p>Here we select the inbox by calling <code class="literal">select_folder()</code> on the <code class="literal">IMAPClient</code> object and passing <code class="literal">'INBOX'</code> as the first argument; we also pass the keyword argument <code class="literal">readonly=False</code> so that we can delete emails ➊. We search the inbox for messages received on a specific date and store the returned message IDs in <code class="literal">UIDs</code> ➋. Calling <code class="literal">delete_message()</code> and passing it <code class="literal">UIDs</code> returns a dictionary; each key-value pair is a message ID and a tuple of the message’s flags, which should now include <span class="emphasis"><em>\Deleted</em></span> ➌. Calling <code class="literal">expunge()</code> then permanently deletes messages with the <span class="emphasis"><em>\Deleted</em></span> flag and returns a success message if there were no problems expunging the emails. Note that some email providers, such as Gmail, automatically expunge emails deleted with <code class="literal">delete_messages()</code> instead of waiting for an expunge command from the IMAP client.</p></div><div class="sect2" title="Disconnecting from the IMAP Server"><div class="titlepage"><div><div><h2 class="title"><a id="disconnecting_from_the_imap_server"/>Disconnecting from the IMAP Server</h2></div></div></div><p>When your program has finished retrieving or deleting emails, simply call the IMAPClient’s <code class="literal">logout()</code> method to disconnect from the IMAP server.</p><a id="pro_id00586"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>imapObj.logout()</strong></span></pre><p><a id="iddle1400" class="indexterm"/><a id="iddle1439" class="indexterm"/><a id="iddle2196" class="indexterm"/><a id="iddle2410" class="indexterm"/><a id="iddle2412" class="indexterm"/><a id="iddle2413" class="indexterm"/>If your program runs for several minutes or more, the IMAP server may <span class="emphasis"><em>time out</em></span>, or automatically disconnect. In this case, the next method call your program makes on the <code class="literal">IMAPClient</code> object will raise an exception like the following:</p><a id="pro_id00587"/><pre class="programlisting">imaplib.abort: socket error: [WinError 10054] An existing connection was
forcibly closed by the remote host</pre><p>In this event, your program will have to call <code class="literal">imapclient.IMAPClient()</code> to connect again.</p><p>Whew! That’s it. There were a lot of hoops to jump through, but you now have a way to get your Python programs to log in to an email account and fetch emails. You can always consult the overview in <a class="xref" href="ch16.html#retrieving_and_deleting_emails_with_imap" title="Retrieving and Deleting Emails with IMAP">Retrieving and Deleting Emails with IMAP</a> whenever you need to remember all of the steps.</p></div></div><div class="sect1" title="Project: Sending Member Dues Reminder Emails"><div class="titlepage"><div><div><h1 class="title"><a id="project_sending_member_dues_reminder_ema"/>Project: Sending Member Dues Reminder Emails</h1></div></div></div><p>Say you have been “volunteered” to track member dues for the Mandatory Volunteerism Club. This is a truly boring job, involving maintaining a spreadsheet of everyone who has paid each month and emailing reminders to those who haven’t. Instead of going through the spreadsheet yourself and copying and pasting the same email to everyone who is behind on dues, let’s—you guessed it—write a script that does this for you.</p><p>At a high level, here’s what your program will do:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Read data from an Excel spreadsheet.</p></li><li class="listitem"><p>Find all members who have not paid dues for the latest month.</p></li><li class="listitem"><p>Find their email addresses and send them personalized reminders.</p></li></ul></div><p>This means your code will need to do the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Open and read the cells of an Excel document with the <code class="literal">openpyxl</code> module. (See <a class="xref" href="ch12.html" title="Chapter 12. Working with Excel Spreadsheets">Chapter 12</a> for working with Excel files.)</p></li><li class="listitem"><p>Create a dictionary of members who are behind on their dues.</p></li><li class="listitem"><p>Log in to an SMTP server by calling <code class="literal">smtplib.SMTP()</code>, <code class="literal">ehlo()</code>, <code class="literal">starttls()</code>, and <code class="literal">login()</code>.</p></li><li class="listitem"><p>For all members behind on their dues, send a personalized reminder email by calling the <code class="literal">sendmail()</code> method.</p></li></ul></div><p>Open a new file editor window and save it as <span class="emphasis"><em>sendDuesReminders.py</em></span>.</p><div class="sect2" title="Step 1: Open the Excel File"><div class="titlepage"><div><div><h2 class="title"><a id="step_1_open_the_excel_file"/>Step 1: Open the Excel File</h2></div></div></div><p>Let’s say the Excel spreadsheet you use to track membership dues payments looks like <a class="xref" href="ch16.html#spreadsheet_for_tracking_member_dues_pay" title="Figure 16-2. The spreadsheet for tracking member dues payments">Figure 16-2</a> and is in a file named <span class="emphasis"><em>duesRecords.xlsx</em></span>. You can download this file from <span class="emphasis"><em><a class="ulink" href="http://nostarch.com/automatestuff/">http://nostarch.com/automatestuff/</a></em></span>.</p><div class="figure"><a id="spreadsheet_for_tracking_member_dues_pay"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00079"/><img src="figs/web/16fig02.png.jpg" alt="The spreadsheet for tracking member dues payments"/></div></div><p class="title">Figure 16-2. The spreadsheet for tracking member dues payments</p></div><p><a id="iddle1593" class="indexterm"/>This spreadsheet has every member’s name and email address. Each month has a column tracking members’ payment statuses. The cell for each member is marked with the text <span class="emphasis"><em>paid</em></span> once they have paid their dues.</p><p>The program will have to open <span class="emphasis"><em>duesRecords.xlsx</em></span> and figure out the column for the latest month by calling the <code class="literal">get_highest_column()</code> method. (You can consult <a class="xref" href="ch12.html" title="Chapter 12. Working with Excel Spreadsheets">Chapter 12</a> for more information on accessing cells in Excel spreadsheet files with the <code class="literal">openpyxl</code> module.) Enter the following code into the file editor window:</p><a id="pro_id00588"/><pre class="programlisting">   #! python3
   # sendDuesReminders.py - Sends emails based on payment status in spreadsheet.

   import openpyxl, smtplib, sys

   # Open the spreadsheet and get the latest dues status.
➊ wb = openpyxl.load_workbook('duesRecords.xlsx')
➋ sheet = wb.get_sheet_by_name('Sheet1')

➌ lastCol = sheet.get_highest_column()
➍ latestMonth = sheet.cell(row=1, column=lastCol).value

   # TODO: Check each member's payment status.

   # TODO: Log in to email account.

   # TODO: Send out reminder emails.</pre><p>After importing the <code class="literal">openpyxl</code>, <code class="literal">smtplib</code>, and <code class="literal">sys</code> modules, we open our <span class="emphasis"><em>duesRecords.xlsx</em></span> file and store the resulting <code class="literal">Workbook</code> object in <code class="literal">wb</code> ➊. Then we get Sheet 1 and store the resulting <code class="literal">Worksheet</code> object in <code class="literal">sheet</code> ➋. Now that we have a <code class="literal">Worksheet</code> object, we can access rows, columns, and cells. We store the highest column in <code class="literal">lastCol</code> ➌, and we then use row number 1 and <code class="literal">lastCol</code> to access the cell that should hold the most recent month. We get the value in this cell and store it in <code class="literal">latestMonth</code> ➍.</p></div><div class="sect2" title="Step 2: Find All Unpaid Members"><div class="titlepage"><div><div><h2 class="title"><a id="step_2_find_all_unpaid_members"/>Step 2: Find All Unpaid Members</h2></div></div></div><p><a id="iddle2411" class="indexterm"/><a id="iddle2414" class="indexterm"/>Once you’ve determined the column number of the latest month (stored in <code class="literal">lastCol</code>), you can loop through all rows after the first row (which has the column headers) to see which members have the text <span class="emphasis"><em>paid</em></span> in the cell for that month’s dues. If the member hasn’t paid, you can grab the member’s name and email address from columns 1 and 2, respectively. This information will go into the <code class="literal">unpaidMembers</code> dictionary, which will track all members who haven’t paid in the most recent month. Add the following code to <span class="emphasis"><em>sendDuesReminder.py</em></span>.</p><a id="pro_id00589"/><pre class="programlisting">   #! python3
   # sendDuesReminders.py - Sends emails based on payment status in spreadsheet.

   <span class="emphasis"><em>--snip--</em></span>

   <span class="strong"><strong># Check each member's payment status.</strong></span>
   <span class="strong"><strong>unpaidMembers = {}</strong></span>
➊ <span class="strong"><strong>for r in range(2, sheet.get_highest_row() + 1):</strong></span>
➋     <span class="strong"><strong>payment = sheet.cell(row=r, column=lastCol).value</strong></span>
       <span class="strong"><strong>if payment != 'paid':</strong></span>
➌         <span class="strong"><strong>name = sheet.cell(row=r, column=1).value</strong></span>
➍         <span class="strong"><strong>email = sheet.cell(row=r, column=2).value</strong></span>
➎         <span class="strong"><strong>unpaidMembers[name] = email</strong></span></pre><p>This code sets up an empty dictionary <code class="literal">unpaidMembers</code> and then loops through all the rows after the first ➊. For each row, the value in the most recent column is stored in <code class="literal">payment</code> ➋. If <code class="literal">payment</code> is not equal to <code class="literal">'paid'</code>, then the value of the first column is stored in <code class="literal">name</code> ➌, the value of the second column is stored in <code class="literal">email</code> ➍, and <code class="literal">name</code> and <code class="literal">email</code> are added to <code class="literal">unpaidMembers</code> ➎.</p></div><div class="sect2" title="Step 3: Send Customized Email Reminders"><div class="titlepage"><div><div><h2 class="title"><a id="step_3_send_customized_email_reminders"/>Step 3: Send Customized Email Reminders</h2></div></div></div><p>Once you have a list of all unpaid members, it’s time to send them email reminders. Add the following code to your program, except with your real email address and provider information:</p><a id="pro_id00590"/><pre class="programlisting">#! python3
# sendDuesReminders.py - Sends emails based on payment status in spreadsheet.

<span class="emphasis"><em>--snip--</em></span>

<span class="strong"><strong># Log in to email account.</strong></span>
<span class="strong"><strong>smtpObj = smtplib.SMTP('smtp.gmail.com', 587)</strong></span>
<span class="strong"><strong>smtpObj.ehlo()</strong></span>
<span class="strong"><strong>smtpObj.starttls()</strong></span>
<span class="strong"><strong>smtpObj.login('</strong></span> <span class="emphasis"><em><span class="strong"><strong>my_email_address@gmail.com</strong></span></em></span> <span class="strong"><strong>', sys.argv[1])</strong></span></pre><p><a id="iddle1375" class="indexterm"/><a id="iddle1875" class="indexterm"/><a id="iddle2274" class="indexterm"/><a id="iddle2417" class="indexterm"/><a id="iddle2473" class="indexterm"/>Create an <code class="literal">SMTP</code> object by calling <code class="literal">smtplib.SMTP()</code> and passing it the domain name and port for your provider. Call <code class="literal">ehlo()</code> and <code class="literal">starttls()</code>, and then call <code class="literal">login()</code> and pass it your email address and <code class="literal">sys.argv[1]</code>, which will store your password string. You’ll enter the password as a command line argument each time you run the program, to avoid saving your password in your source code.</p><p>Once your program has logged in to your email account, it should go through the <code class="literal">unpaidMembers</code> dictionary and send a personalized email to each member’s email address. Add the following to <span class="emphasis"><em>sendDuesReminders.py</em></span>:</p><a id="pro_id00591"/><pre class="programlisting">   #! python3
   # sendDuesReminders.py - Sends emails based on payment status in spreadsheet.

   <span class="emphasis"><em>--snip--</em></span>

   <span class="strong"><strong># Send out reminder emails.</strong></span>
   <span class="strong"><strong>for name, email in unpaidMembers.items():</strong></span>
➊     <span class="strong"><strong>body = "Subject: %s dues unpaid.\nDear %s,\nRecords show that you have not</strong></span>
   <span class="strong"><strong>paid dues for %s. Please make this payment as soon as possible. Thank you!'" %</strong></span>
   <span class="strong"><strong>(latestMonth, name, latestMonth)</strong></span>
➋     <span class="strong"><strong>print('Sending email to %s...' % email)</strong></span>
➌     <span class="strong"><strong>sendmailStatus = smtpObj.sendmail('<span class="emphasis"><em>my_email_address@gmail.com</em></span>', email, body)</strong></span>

➍     <span class="strong"><strong>if sendmailStatus != {}:</strong></span>
           <span class="strong"><strong>print('There was a problem sending email to %s: %s' % (email,</strong></span>
           <span class="strong"><strong>sendmailStatus))</strong></span>
   <span class="strong"><strong>smtpObj.quit()</strong></span></pre><p>This code loops through the names and emails in <code class="literal">unpaidMembers</code>. For each member who hasn’t paid, we customize a message with the latest month and the member’s name, and store the message in <code class="literal">body</code> ➊. We print output saying that we’re sending an email to this member’s email address ➋. Then we call <code class="literal">sendmail()</code>, passing it the from address and the customized message ➌. We store the return value in <code class="literal">sendmailStatus</code>.</p><p>Remember that the <code class="literal">sendmail()</code> method will return a nonempty dictionary value if the SMTP server reported an error sending that particular email. The last part of the <code class="literal">for</code> loop at ➍ checks if the returned dictionary is nonempty, and if it is, prints the recipient’s email address and the returned dictionary.</p><p>After the program is done sending all the emails, the <code class="literal">quit()</code> method is called to disconnect from the SMTP server.</p><p>When you run the program, the output will look something like this:</p><a id="pro_id00592"/><pre class="programlisting">Sending email to alice@example.com...
Sending email to bob@example.com...
Sending email to eve@example.com...</pre><p>The recipients will receive an email that looks like <a class="xref" href="ch16.html#automatically_sent_email_from_sendduesre" title="Figure 16-3. An automatically sent email from sendDuesReminders.py">Figure 16-3</a>.</p><div class="figure"><a id="automatically_sent_email_from_sendduesre"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00080"/><img src="figs/web/16fig03.png.jpg" alt="An automatically sent email from sendDuesReminders.py"/></div></div><p class="title">Figure 16-3. An automatically sent email from <span class="emphasis"><em>sendDuesReminders.py</em></span></p></div></div></div><div class="sect1" title="Sending Text Messages with Twilio"><div class="titlepage"><div><div><h1 class="title"><a id="sending_text_messages_with_twilio"/>Sending Text Messages with Twilio</h1></div></div></div><p><a id="iddle2425" class="indexterm"/><a id="iddle2444" class="indexterm"/><a id="iddle2553" class="indexterm"/><a id="iddle2594" class="indexterm"/><a id="iddle2597" class="indexterm"/>Most people are more likely to be near their phones than their computers, so text messages can be a more immediate and reliable way of sending notifications than email. Also, the short length of text messages makes it more likely that a person will get around to reading them.</p><p>In this section, you’ll learn how to sign up for the free Twilio service and use its Python module to send text messages. Twilio is an <span class="emphasis"><em>SMS gateway service</em></span>, which means it’s a service that allows you to send text messages from your programs. Although you will be limited in how many texts you can send per month and the texts will be prefixed with the words <span class="emphasis"><em>Sent from a Twilio trial account</em></span>, this trial service is probably adequate for your personal programs. The free trial is indefinite; you won’t have to upgrade to a paid plan later.</p><p>Twilio isn’t the only SMS gateway service. If you prefer not to use Twilio, you can find alternative services by searching online for <span class="emphasis"><em>free sms gateway</em></span>, <span class="emphasis"><em>python sms api</em></span>, or even <span class="emphasis"><em>twilio alternatives</em></span>.</p><p>Before signing up for a Twilio account, install the <code class="literal">twilio</code> module. Appendix A has more details about installing third-party modules.</p><div class="note" title="Note"><h3 class="title"><a id="ch16note05"/>Note</h3><p><span class="emphasis"><em>This section is specific to the United States. Twilio does offer SMS texting services for countries outside of the United States, but those specifics aren’t covered in this book. The <code class="literal">twilio</code> module and its functions, however, will work the same outside the United States. See</em></span> <a class="ulink" href="http://twilio.com/">http://twilio.com/</a> <span class="emphasis"><em>for more information.</em></span></p></div><div class="sect2" title="Signing Up for a Twilio Account"><div class="titlepage"><div><div><h2 class="title"><a id="signing_up_for_a_twilio_account"/>Signing Up for a Twilio Account</h2></div></div></div><p>Go to <span class="emphasis"><em><a class="ulink" href="http://twilio.com/">http://twilio.com/</a></em></span> and fill out the sign-up form. Once you’ve signed up for a new account, you’ll need to verify a mobile phone number that you want to send texts to. (This verification is necessary to prevent people from using the service to spam random phone numbers with text messages.)</p><p>After receiving the text with the verification number, enter it into the Twilio website to prove that you own the mobile phone you are verifying. You will now be able to send texts to this phone number using the <code class="literal">twilio</code> module.</p><p>Twilio provides your trial account with a phone number to use as the sender of text messages. You will need two more pieces of information: your account SID and the auth (authentication) token. You can find this information on the Dashboard page when you are logged in to your Twilio account. These values act as your Twilio username and password when logging in from a Python program.</p></div><div class="sect2" title="Sending Text Messages"><div class="titlepage"><div><div><h2 class="title"><a id="sending_text_messages"/>Sending Text Messages</h2></div></div></div><p><a id="iddle1908" class="indexterm"/><a id="iddle2424" class="indexterm"/><a id="iddle2443" class="indexterm"/><a id="iddle2552" class="indexterm"/><a id="iddle2595" class="indexterm"/><a id="iddle2598" class="indexterm"/>Once you’ve installed the <code class="literal">twilio</code> module, signed up for a Twilio account, verified your phone number, registered a Twilio phone number, and obtained your account SID and auth token, you will finally be ready to send yourself text messages from your Python scripts.</p><p>Compared to all the registration steps, the actual Python code is fairly simple. With your computer connected to the Internet, enter the following into the interactive shell, replacing the <code class="literal">accountSID</code>, <code class="literal">authToken</code>, <code class="literal">myTwilioNumber</code>, and <code class="literal">myCellPhone</code> variable values with your real information:</p><a id="pro_id00593"/><pre class="programlisting">➊ &gt;&gt;&gt; <span class="strong"><strong>from twilio.rest import TwilioRestClient</strong></span>
   &gt;&gt;&gt; <span class="strong"><strong>accountSID = '<span class="emphasis"><em>ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</em></span>'</strong></span>
   &gt;&gt;&gt; <span class="strong"><strong>authToken = '<span class="emphasis"><em>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</em></span>'</strong></span>
➋ &gt;&gt;&gt; <span class="strong"><strong>twilioCli = TwilioRestClient(accountSID, authToken)</strong></span>
   &gt;&gt;&gt; <span class="strong"><strong>myTwilioNumber = '+14955551234'</strong></span>
   &gt;&gt;&gt; <span class="strong"><strong>myCellPhone = '+14955558888'</strong></span>
➌ &gt;&gt;&gt; <span class="strong"><strong>message = twilioCli.messages.create(body='Mr. Watson - Come here - I want</strong></span>
   <span class="strong"><strong>to see you.', from_=myTwilioNumber, to=myCellPhone)</strong></span></pre><p>A few moments after typing the last line, you should receive a text message that reads <span class="emphasis"><em>Sent from your Twilio trial account - Mr. Watson - Come here - I want to see you</em></span>.</p><p>Because of the way the <code class="literal">twilio</code> module is set up, you need to import it using <code class="literal">from twilio.rest import TwilioRestClient</code>, not just <code class="literal">import twilio</code> ➊. Store your account SID in <code class="literal">accountSID</code> and your auth token in <code class="literal">authToken</code> and then call <code class="literal">TwilioRestClient()</code> and pass it <code class="literal">accountSID</code> and <code class="literal">authToken</code>. The call to <code class="literal">TwilioRestClient()</code> returns a <code class="literal">TwilioRestClient</code> object ➋. This object has a <code class="literal">messages</code> attribute, which in turn has a <code class="literal">create()</code> method you can use to send text messages. This is the method that will instruct Twilio’s servers to send your text message. After storing your Twilio number and cell phone number in <code class="literal">myTwilioNumber</code> and <code class="literal">myCellPhone</code>, respectively, call <code class="literal">create()</code> and pass it keyword arguments specifying the body of the text message, the sender’s number (<code class="literal">myTwilioNumber</code>), and the recipient’s number (<code class="literal">myCellPhone</code>) ➌.</p><p>The <code class="literal">Message</code> object returned from the <code class="literal">create()</code> method will have information about the text message that was sent. Continue the interactive shell example by entering the following:</p><a id="pro_id00594"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>message.to</strong></span>
'+14955558888'
&gt;&gt;&gt; <span class="strong"><strong>message.from</strong></span>_
'+14955551234'
&gt;&gt;&gt; <span class="strong"><strong>message.body</strong></span>
'Mr. Watson - Come here - I want to see you.'</pre><p>The <code class="literal">to</code>, <code class="literal">from_</code>, and <code class="literal">body</code> attributes should hold your cell phone number, Twilio number, and message, respectively. Note that the sending phone number is in the <code class="literal">from_</code> attribute—with an underscore at the end—not <code class="literal">from</code>. This is because <code class="literal">from</code> is a keyword in Python (you’ve seen it used in the <code class="literal">from</code> <a id="iddle2429" class="indexterm"/><a id="iddle2485" class="indexterm"/><code class="literal">modulename import *</code> form of <code class="literal">import</code> statement, for example), so it cannot be used as an attribute name. Continue the interactive shell example with the following:</p><a id="pro_id00595"/><pre class="programlisting">&gt;&gt;&gt; <span class="strong"><strong>message.status</strong></span>
'queued'
&gt;&gt;&gt; <span class="strong"><strong>message.date_created</strong></span>
datetime.datetime(2015, 7, 8, 1, 36, 18)
&gt;&gt;&gt; <span class="strong"><strong>message.date_sent == None</strong></span>
True</pre><p>The <code class="literal">status</code> attribute should give you a string. The <code class="literal">date_created</code> and <code class="literal">date_sent</code> attributes should give you a <code class="literal">datetime</code> object if the message has been created and sent. It may seem odd that the <code class="literal">status</code> attribute is set to <code class="literal">'queued'</code> and the <code class="literal">date_sent</code> attribute is set to <code class="literal">None</code> when you’ve already received the text message. This is because you captured the <code class="literal">Message</code> object in the <code class="literal">message</code> variable <span class="emphasis"><em>before</em></span> the text was actually sent. You will need to refetch the <code class="literal">Message</code> object in order to see its most up-to-date <code class="literal">status</code> and <code class="literal">date_sent</code>. Every Twilio message has a unique string ID (SID) that can be used to fetch the latest update of the <code class="literal">Message</code> object. Continue the interactive shell example by entering the following:</p><a id="pro_id00596"/><pre class="programlisting">   &gt;&gt;&gt; <span class="strong"><strong>message.sid</strong></span>
   'SM09520de7639ba3af137c6fcb7c5f4b51'
➊ &gt;&gt;&gt; <span class="strong"><strong>updatedMessage = twilioCli.messages.get(message.sid)</strong></span>
   &gt;&gt;&gt; <span class="strong"><strong>updatedMessage.status</strong></span>
   'delivered'
   &gt;&gt;&gt; <span class="strong"><strong>updatedMessage.date_sent</strong></span>
   datetime.datetime(2015, 7, 8, 1, 36, 18)</pre><p>Entering <code class="literal">message.sid</code> show you this message’s long SID. By passing this SID to the Twilio client’s <code class="literal">get()</code> method ➊, you can retrieve a new <code class="literal">Message</code> object with the most up-to-date information. In this new <code class="literal">Message</code> object, the <code class="literal">status</code> and <code class="literal">date_sent</code> attributes are correct.</p><p>The <code class="literal">status</code> attribute will be set to one of the following string values: <code class="literal">'queued'</code>, <code class="literal">'sending'</code>, <code class="literal">'sent'</code>, <code class="literal">'delivered'</code>, <code class="literal">'undelivered'</code>, or <code class="literal">'failed'</code>. These statuses are self-explanatory, but for more precise details, take a look at the resources at <span class="emphasis"><em><a class="ulink" href="http://nostarch.com/automatestuff/">http://nostarch.com/automatestuff/</a></em></span>.</p><div class="sidebar"><a id="receiving_text_messages_with_python"/><p class="title">Receiving Text Messages with Python</p><p>Unfortunately, receiving text messages with Twilio is a bit more complicated than sending them. Twilio requires that you have a website running its own web application. That’s beyond the scope of this book, but you can find more details in the resources for this book (<span class="emphasis"><em><a class="ulink" href="http://nostarch.com/automatestuff/">http://nostarch.com/automatestuff/</a></em></span>).</p></div></div></div><div class="sect1" title="Project: “Just Text Me” Module"><div class="titlepage"><div><div><h1 class="title"><a id="project_quotation_markjust_text_mequotat"/>Project: “Just Text Me” Module</h1></div></div></div><p><a id="iddle2187" class="indexterm"/><a id="iddle2551" class="indexterm"/><a id="iddle2596" class="indexterm"/>The person you’ll most often text from your programs is probably you. Texting is a great way to send yourself notifications when you’re away from your computer. If you’ve automated a boring task with a program that takes a couple of hours to run, you could have it notify you with a text when it’s finished. Or you may have a regularly scheduled program running that sometimes needs to contact you, such as a weather-checking program that texts you a reminder to pack an umbrella.</p><p>As a simple example, here’s a small Python program with a <code class="literal">textmyself()</code> function that sends a message passed to it as a string argument. Open a new file editor window and enter the following code, replacing the account SID, auth token, and phone numbers with your own information. Save it as <span class="emphasis"><em>textMyself.py</em></span>.</p><a id="pro_id00597"/><pre class="programlisting">   #! python3
   # textMyself.py - Defines the textmyself() function that texts a message
   # passed to it as a string.

   # Preset values:
   accountSID = '<span class="emphasis"><em>ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</em></span>'
   authToken = '<span class="emphasis"><em>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</em></span>'
   myNumber = '+15559998888'
   twilioNumber = '+15552225678'

   from twilio.rest import TwilioRestClient

➊ def textmyself(message):
➋     twilioCli = TwilioRestClient(accountSID, authToken)
➌     twilioCli.messages.create(body=message, from_=twilioNumber, to=myNumber)</pre><p>This program stores an account SID, auth token, sending number, and receiving number. It then defined <code class="literal">textmyself()</code> to take on argument ➊, make a <code class="literal">TwilioRestClient</code> object ➋, and call <code class="literal">create()</code> with the message you passed ➌.</p><p>If you want to make the <code class="literal">textmyself()</code> function available to your other programs, simply place the <span class="emphasis"><em>textMyself.py</em></span> file in the same folder as the Python executable (<span class="emphasis"><em>C:\Python34</em></span> on Windows, <span class="emphasis"><em>/usr/local/lib/python3.4</em></span> on OS X, and <span class="emphasis"><em>/usr/bin/python3</em></span> on Linux). Now you can use the function in your other programs. Whenever you want one of your programs to text you, just add the following:</p><a id="pro_id00598"/><pre class="programlisting">import textmyself
textmyself.textmyself('The boring task is finished.')</pre><p>You need to sign up for Twilio and write the texting code only once. After that, it’s just two lines of code to send a text from any of your other programs.</p></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="summary-id00059"/>Summary</h1></div></div></div><p>We communicate with each other on the Internet and over cell phone networks in dozens of different ways, but email and texting predominate. Your programs can communicate through these channels, which gives them powerful new notification features. You can even write programs running on different computers that communicate with one another directly via email, with one program sending emails with SMTP and the other retrieving them with IMAP.</p><p>Python’s <code class="literal">smtplib</code> provides functions for using the SMTP to send emails through your email provider’s SMTP server. Likewise, the third-party <code class="literal">imapclient</code> and <code class="literal">pyzmail</code> modules let you access IMAP servers and retrieve emails sent to you. Although IMAP is a bit more involved than SMTP, it’s also quite powerful and allows you to search for particular emails, download them, and parse them to extract the subject and body as string values.</p><p>Texting is a bit different from email, since, unlike email, more than just an Internet connection is needed to send SMS texts. Fortunately, services such as Twilio provide modules to allow you to send text messages from your programs. Once you go through an initial setup process, you’ll be able to send texts with just a couple lines of code.</p><p>With these modules in your skill set, you’ll be able to program the specific conditions under which your programs should send notifications or reminders. Now your programs will have reach far beyond the computer they’re running on!</p></div><div class="sect1" title="Practice Questions"><div class="titlepage"><div><div><h1 class="title"><a id="practice_questions-id00060"/>Practice Questions</h1></div></div></div><div class="qandaset" title="Frequently Asked Questions"><a id="ch16qa1"/><table border="0" width="100%" summary="Q and A Set"><col align="left" width="1%"/><col/><tbody><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch16qa1qe1"/><a id="ch16qa1q1"/><p>Q:</p></td><td align="left" valign="top"><p>1. What is the protocol for sending email? For checking and receiving email?</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch16qa1qe2"/><a id="ch16qa1q2"/><p>Q:</p></td><td align="left" valign="top"><p>2. What four <code class="literal">smtplib</code> functions/methods must you call to log in to an SMTP server?</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch16qa1qe3"/><a id="ch16qa1q3"/><p>Q:</p></td><td align="left" valign="top"><p>3. What two <code class="literal">imapclient</code> functions/methods must you call to log in to an IMAP server?</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch16qa1qe4"/><a id="ch16qa1q4"/><p>Q:</p></td><td align="left" valign="top"><p>4. What kind of argument do you pass to <code class="literal">imapObj.search()</code>?</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch16qa1qe5"/><a id="ch16qa1q5"/><p>Q:</p></td><td align="left" valign="top"><p>5. What do you do if your code gets an error message that says <code class="literal">got more than 10000 bytes</code>?</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch16qa1qe6"/><a id="ch16qa1q6"/><p>Q:</p></td><td align="left" valign="top"><p>6. The <code class="literal">imapclient</code> module handles connecting to an IMAP server and finding emails. What is one module that handles reading the emails that <code class="literal">imapclient</code> collects?</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch16qa1qe7"/><a id="ch16qa1q7"/><p>Q:</p></td><td align="left" valign="top"><p>7. What three pieces of information do you need from Twilio before you can send text messages?</p></td></tr></tbody></table></div></div><div class="sect1" title="Practice Projects"><div class="titlepage"><div><div><h1 class="title"><a id="practice_projects-id00061"/>Practice Projects</h1></div></div></div><p>For practice, write programs that do the following.</p><div class="sect2" title="Random Chore Assignment Emailer"><div class="titlepage"><div><div><h2 class="title"><a id="random_chore_assignment_emailer"/>Random Chore Assignment Emailer</h2></div></div></div><p>Write a program that takes a list of people’s email addresses and a list of chores that need to be done and randomly assigns chores to people. Email each person their assigned chores. If you’re feeling ambitious, keep a record of each person’s previously assigned chores so that you can make sure the program avoids assigning anyone the same chore they did last time. For another possible feature, schedule the program to run once a week automatically.</p><p>Here’s a hint: If you pass a list to the <code class="literal">random.choice()</code> function, it will return a randomly selected item from the list. Part of your code could look like this:</p><a id="pro_id00599"/><pre class="programlisting">chores = ['dishes', 'bathroom', 'vacuum', 'walk dog']
randomChore = random.choice(chores)
chores.remove(randomChore) # this chore is now taken, so remove it</pre></div><div class="sect2" title="Umbrella Reminder"><div class="titlepage"><div><div><h2 class="title"><a id="umbrella_reminder"/>Umbrella Reminder</h2></div></div></div><p><a class="xref" href="ch11.html" title="Chapter 11. Web Scraping">Chapter 11</a> showed you how to use the <code class="literal">requests</code> module to scrape data from <span class="emphasis"><em><a class="ulink" href="http://weather.gov/">http://weather.gov/</a></em></span>. Write a program that runs just before you wake up in the morning and checks whether it’s raining that day. If so, have the program text you a reminder to pack an umbrella before leaving the house.</p></div><div class="sect2" title="Auto Unsubscriber"><div class="titlepage"><div><div><h2 class="title"><a id="auto_unsubscriber"/>Auto Unsubscriber</h2></div></div></div><p>Write a program that scans through your email account, finds all the unsubscribe links in all your emails, and automatically opens them in a browser. This program will have to log in to your email provider’s IMAP server and download all of your emails. You can use BeautifulSoup (covered in <a class="xref" href="ch11.html" title="Chapter 11. Web Scraping">Chapter 11</a>) to check for any instance where the word <span class="emphasis"><em>unsubscribe</em></span> occurs within an HTML link tag.</p><p>Once you have a list of these URLs, you can use <code class="literal">webbrowser.open()</code> to automatically open all of these links in a browser.</p><p>You’ll still have to manually go through and complete any additional steps to unsubscribe yourself from these lists. In most cases, this involves clicking a link to confirm.</p><p>But this script saves you from having to go through all of your emails looking for unsubscribe links. You can then pass this script along to your friends so they can run it on their email accounts. (Just make sure your email password isn’t hardcoded in the source code!)</p></div><div class="sect2" title="Controlling Your Computer Through Email"><div class="titlepage"><div><div><h2 class="title"><a id="controlling_your_computer_through_email"/>Controlling Your Computer Through Email</h2></div></div></div><p>Write a program that checks an email account every 15 minutes for any instructions you email it and executes those instructions automatically. For example, BitTorrent is a peer-to-peer downloading system. Using free BitTorrent software such as qBittorrent, you can download large media files on your home computer. If you email the program a (completely legal, not at all piratical) BitTorrent link, the program will eventually check its email, find this message, extract the link, and then launch qBittorrent to start downloading the file. This way, you can have your home computer begin downloads while you’re away, and the (completely legal, not at all piratical) download can be finished by the time you return home.</p><p><a class="xref" href="ch15.html" title="Chapter 15. Keeping Time, Scheduling Tasks, and Launching Programs">Chapter 15</a> covers how to launch programs on your computer using the <code class="literal">subprocess.Popen()</code> function. For example, the following call would launch the qBittorrent program, along with a torrent file:</p><a id="pro_id00600"/><pre class="programlisting">qbProcess = subprocess.Popen(['C:\\Program Files (x86)\\qBittorrent\\
qbittorrent.exe', 'shakespeare_complete_works.torrent'])</pre><p>Of course, you’ll want the program to make sure the emails come from you. In particular, you might want to require that the emails contain a password, since it is fairly trivial for hackers to fake a “from” address in emails. The program should delete the emails it finds so that it doesn’t repeat instructions every time it checks the email account. As an extra feature, have the program email or text you a confirmation every time it executes a command. Since you won’t be sitting in front of the computer that is running the program, it’s a good idea to use the logging functions (see <a class="xref" href="ch10.html" title="Chapter 10. Debugging">Chapter 10</a>) to write a text file log that you can check if errors come up.</p><p>qBittorrent (as well as other BitTorrent applications) has a feature where it can quit automatically after the download completes. <a class="xref" href="ch15.html" title="Chapter 15. Keeping Time, Scheduling Tasks, and Launching Programs">Chapter 15</a> explains how you can determine when a launched application has quit with the <code class="literal">wait()</code> method for <code class="literal">Popen</code> objects. The <code class="literal">wait()</code> method call will block until qBittorrent has stopped, and then your program can email or text you a notification that the download has completed.</p><p>There are a lot of possible features you could add to this project. If you get stuck, you can download an example implementation of this program from <span class="emphasis"><em><a class="ulink" href="http://nostarch.com/automatestuff/">http://nostarch.com/automatestuff/</a></em></span>.</p></div></div></div></body></html>
